<!DOCTYPE html>
<html>
	<head>
		<!-- Page formatting information -->
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<meta name="Author" content="Chantal Kronenburg & Aaron Krupp, Caminos de Agua"/>
		
		<!-- Include jquery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<!-- Include both libraries for plotting stamen basemaps --> 
		
		<!--<script type="text/javascript" src="https://stamen-maps.a.ssl.fastly.net/js/tile.stamen.js"></script>-->
		
		
		<script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
		<link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
		
		<!-- Include Leaflet libraries (through carto) including leaflet label plugin -->
		<link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/themes/css/cartodb.css"></link>
		<script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js"></script>
		<script src="https://leaflet.github.io/Leaflet.label/leaflet.label.js"></script> <!-- files necessary for labels in leaflet -->
		
		<!-- Include stuff required for easy full-screen option --> 
		<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
		<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
		
		
		<!-- Include stylesheets for calculator and map -->
		<link rel="stylesheet" type="text/css" href="calc_styles.css"></link>
		<link rel="stylesheet" type="text/css" href="rainmap_styles.css"></link>
		<!-- Include globals for calc and rainmap and scripts for rainmap -->
		<script src="globals.js" type="text/javascript"></script>
		<script src="rainmap_global.js" type="text/javascript" /></script>
		
		
		
		
		<!-- ----------- MAKE LANGUAGE CHANGES HERE!!! ------------- -->
		<!-- Include text-to-display file of the relevant language:
			make sure to select "calc_English.js" or "calc_Spanish.js"
			and the same for the rainmap files. --> 	
		<script src="calc_Spanish.js" type="text/javascript"></script>
		<script src="rainmap_display_English.js" type="text/javascript"></script>
		<!------------------------------------------------------------->
		
		<script src="rainmap_scripts.js" type="text/javascript" /></script>
		
		<script>
			document.title = CALC_TITLE; 		// Adds title to calc from calc_Language.js
		</script>
		

	</head>
	<body onload="init();">
	
		<!-- Left hand side (inputs) for the calculator -->
		<div id="left_hand_side">
			<div id="LHS_inputs">
				<!-- the top text goes here -->
				<a id="caminos_logo" href="https://www.caminosdeaguamexico.org" target="_blank">
					<img class="caminos_logo_img" src="https://dl.dropboxusercontent.com/s/g6mddl4xk9wgmxp/caminos_logo_circle.png"></img>
				</a>
				<h1 class="headers" id="header"></h1>
				<h3 class="headers" id="sub_header"></h3>

				
				<!-- start the form!!! -->
				<form id="calc_form" class="form">
					<div style="text-align: center;"> <!-- this div is necessary to easily center the form box, see http://stackoverflow.com/questions/283961/centering-a-div-block-without-the-width for details -->
						<div id="form_box">
							<big><p class="headers" id="instructions" align="center"></p></big>
							<!-- Select your municipality -->
							<div style="display: inline-block;">
								<div id="form_box_left" class="inside_form_box">
									<div id="WaterMapDiv" style="padding-top: 10px;">
										<label id="muni0" class="map_related_text"></label><br>
										<div id="WaterMap"></div>
									</div>
									<div id="MonthlyUseDiv">
										<p id="monthly_rain_lbl"></p>
										<div class="rain_column" id="rain_column_1">
											<div class="rain_entry_wrapper"><label for="jan_rain" name="rain_lbl"></label><input class="rain_lbl" type="number" id ="jan_rain" name="rain" value="none" min="0" step="any" /></div>
											<div class="rain_entry_wrapper"><label for="feb_rain" name="rain_lbl"></label><input class="rain_lbl" type="number" id ="feb_rain" name="rain" value="none" min="0" step="any" /></div>                                                                                                                           
											<div class="rain_entry_wrapper"><label for="mar_rain" name="rain_lbl"></label><input class="rain_lbl" type="number" id ="mar_rain" name="rain" value="none" min="0" step="any" /></div>                              
											<div class="rain_entry_wrapper"><label for="apr_rain" name="rain_lbl"></label><input class="rain_lbl" type="number" id ="apr_rain" name="rain" value="none" min="0" step="any" /></div>
										</div>                                                                                                                                
																																											
										<div class="rain_column" id="rain_column_2">                                                                                                                                
											<div class="rain_entry_wrapper"><label for="may_rain" name="rain_lbl"></label><input class="rain_lbl" type="number" id ="may_rain" name="rain" value="none" min="0" step="any" /></div>
											<div class="rain_entry_wrapper"><label for="jun_rain" name="rain_lbl"></label><input class="rain_lbl" type="number" id ="jun_rain" name="rain" value="none" min="0" step="any" /></div>                                     
											<div class="rain_entry_wrapper"><label for="jul_rain" name="rain_lbl"></label><input class="rain_lbl" type="number" id ="jul_rain" name="rain" value="none" min="0" step="any" /></div>
											<div class="rain_entry_wrapper"><label for="aug_rain" name="rain_lbl"></label><input class="rain_lbl" type="number" id ="aug_rain" name="rain" value="none" min="0" step="any" /></div>
										</div>
										
										<div class="rain_column" id="rain_column_3">
											<div class="rain_entry_wrapper"><label for="sep_rain" name="rain_lbl"></label><input class="rain_lbl" type="number" id ="sep_rain" name="rain" value="none" min="0" step="any" /></div>                                       								
											<div class="rain_entry_wrapper"><label for="oct_rain" name="rain_lbl"></label><input class="rain_lbl" type="number" id ="oct_rain" name="rain" value="none" min="0" step="any" /></div>
											<div class="rain_entry_wrapper"><label for="nov_rain" name="rain_lbl"></label><input class="rain_lbl" type="number" id ="nov_rain" name="rain" value="none" min="0" step="any" /></div>
											<div class="rain_entry_wrapper"><label for="dec_rain" name="rain_lbl"></label><input class="rain_lbl" type="number" id ="dec_rain" name="rain" value="none" min="0" step="any" /></div>
										</div>
									</div>
									<br style="font-size: 2px;">
									<div id="monthly_use_cluster">
										<input type="checkbox" id="useMonthly"></input>
										<label for="useMonthly" class="map_related_text" id="useMonthly_lbl" ></label>
									</div>
								</div>
								
								<!-- How many people in your household? -->
								<div id = "full_box_right" class="inside_form_box" align="center">
									<div id="form_box_right" align="left">
										
										<div>
											<label for="ppl" id="ppl0"></label>
											<input type="number" class="number_input" id="ppl" value="1" min="1" max="9999" step="1"/>
										</div>
											
										<!-- Length of your roof -->
										<div>
											<label for="length" id = "length0"></label>
											<input type="number" class="number_input" id="length" value="1" min="1" max="99" step="any"/>
										</div>
										
										<!-- Width of your roof -->
										<div>
											<label for="width" id = "width0"></label>
											<input type="number" class="number_input" id="width" value="1" min="1" max="99" step="any"/>
										</div>
										<br>
										<!-- Type of roof -->
										<div>
											<label id="roof0"></label><br>
											<div class="tooltip_roof" onmouseover="highlight(this)" onmouseleave="unHighlight(this)">
												<input type="radio" id="cement_roof" name="roof_type" value="0" checked>.</input>
												<div name="roof_imgs" class="tooltip_img"></div>
											</div>
											<div class="tooltip_roof" onmouseover="highlight(this)" onmouseleave="unHighlight(this)">
												<input type="radio" id="sheet_roof" name="roof_type" value="1" >.</input>
												<div name="roof_imgs" class="tooltip_img"></div>
											</div>
											<div class="tooltip_roof" onmouseover="highlight(this)" onmouseleave="unHighlight(this)" style="margin-bottom: 20px;">
												<input type="radio" id="spanish_roof" name="roof_type" value="2" >.</input>
												<div name="roof_imgs" class="tooltip_img"></div>
											</div>
										</div>	
									</div>
									<!--When you press this button, it stops letting you edit the form 
									and displays the inputs back to the user -->
									<div class="button" >
										<button type="button" onclick="incrementHash();" id="calc_button"></button>
									</div>
								</div>
							</div>
						</div>
						
					
					</div>
				</form>
			</div>
			<div id="LHS_display">
				<h1 id="header_display"></h1>
				<h3 id="sub_header_display"></h3>
				<p id="instructions_display"></p>
				<div class="to_indent">					
					<p name="display_text">.</p>
					<p name="display_text">.</p>
					<p name="display_text">.</p>
					<p name="display_text">.</p>
					<br><br>
					<div class="button" align="center">
						<button onclick="incrementHash();" id="back2inputs_button" ></button>
					</div>
				</div>
				<p id="ps_note"></p>
			</div>
		</div>
		
		<!-- The right hand side displays the calculated resullts in simple or complex form -->
		<div id="right_hand_side" align="center">
			<div class="footer" align="right"></div>
			
			<div id="real_header" class="results_headers"></div>
			<div class="outer_row" id="top_box">
				<div class="tooltip" id="left" name="real_roof" onmouseover="addTooltipText(this)">
					<span class="tooltiptext"></span>
					<div class="text_in_center">
						<label name="real_roof_lbl" class="output_text"></label><br>
						<label name="real_roof_numb" class="return_num"></label><br>
						<label name="real_roof_lbl" class="output_text"></label>
					</div>
				</div>
					
				<div class="tooltip" id="right" name="real_tank" onmouseover="addTooltipText(this)">
					<span class="tooltiptext"></span>
					<div class="text_in_center">
						<label name="real_tank_lbl" class="output_text"></label><br>
						<label name="real_tank_numb" class="return_num"></label><br>
						<label name="real_tank_lbl" class="output_text"></label>
					</div>
				</div>
			</div>
			
			<div id="min_header" class="results_headers"></div>
			<div class="outer_row" id="bottom_box">
				
				<div class="tooltip" id="left" name="min_roof" onmouseover="addTooltipText(this)">
					<span class="tooltiptext"></span>
					<div class="text_in_center">
						<label name="min_roof_lbl" class="output_text"></label><br>
						<label name="min_roof_numb" class="return_num" ></label><br>
						<label name="min_roof_lbl" class="output_text"></label>
					</div>
				</div>
					
				<div class="tooltip" id="right" name="min_tank" onmouseover="addTooltipText(this)">
					<span class="tooltiptext"></span>
					<div class="text_in_center">
						<label name="min_tank_lbl" class="output_text"></label><br>
						<label name="min_tank_numb" class="return_num"></label><br>
						<label name="min_tank_lbl" class="output_text"></label>
					</div>
				</div>
			</div>
				
				
				
			<a id="caminos_logo2" href="https://www.caminosdeaguamexico.org" target="_blank">
				<img class="caminos_logo_img" src="https://dl.dropboxusercontent.com/s/g6mddl4xk9wgmxp/caminos_logo_circle.png"></img>
			</a>	
		
								
		</div>
		

		
		<script>
			
		
			////////////////////////////////////////////////////////////////////
			////						function init() 					////
			//// 															////
			////	Loads the text in the correct language, and sets up 	////
			////	some basic form parameters.	Initializes the form, 		////
			////	stores the starting values in a global, and hides all	////
			////	error messages and extra text that needs to be hidden. 	////
			////////////////////////////////////////////////////////////////////
		
			function init() {
				
				location.hash = 0;
				
				initForm();
				initEmbeddedMap();							
				
				hideComplexOutput();
				
				setTimeout(function() {
					loadStartingValues();
					displayStuff = inputs2outputs(allData);
					displayOutputs(displayStuff);
					addLanguageText();
				}, 1000)
				
				startInterrupt();
					
			};
			
			////////////////////////////////////////////////////////////////////
			////				function addLanguageText()					////
			//// 															////
			////	Loads the text in the correct display language.			////
			////////////////////////////////////////////////////////////////////
			
			function addLanguageText(){
				document.getElementById("header").innerHTML = HEADER; 				// Puts the correct language text on the page
				document.getElementById("sub_header").innerHTML = SUB_HEADER;		//	for all elements
				document.getElementById("instructions").innerHTML = INSTRUCTIONS;
				document.getElementById("useMonthly_lbl").innerHTML = CHECKBOX_LBL;
				document.getElementById("muni0").innerHTML = MUNI0_LBL;
				document.getElementById("ppl0").innerHTML = PPL0_LBL;
				document.getElementById("length0").innerHTML = LENGTH0_LBL;
				document.getElementById("width0").innerHTML = WIDTH0_LBL;
				document.getElementById("roof0").innerHTML = ROOF0_LBL;
				document.getElementById("cement_roof").nextSibling.data = CEMENT_ROOF_LBL;
				document.getElementById("sheet_roof").nextSibling.data = SHEET_ROOF_LBL;
				document.getElementById("spanish_roof").nextSibling.data = SPANISH_ROOF_LBL;
				document.getElementById("calc_button").innerHTML = CALC_BUTTON_LBL;
				document.getElementById("back2inputs_button").innerHTML = BACK2INPUTS_BUTTON_LBL;
				document.getElementById("header_display").innerHTML = HEADER;
				document.getElementById("sub_header_display").innerHTML = LHS_DISPLAY_TITLE;
				document.getElementById("instructions_display").innerHTML = LHS_INSTRUCTIONS;
				document.getElementById("monthly_rain_lbl").innerHTML = MONTHLY_RAIN_LBL;
				document.getElementById("ps_note").innerHTML = PS_NOTE;
				
				var els = document.getElementsByClassName("footer") 
				for (var i=0; i<els.length; i++) {
					els[i].innerHTML = FOOTER_TXT;
				};
				
				// label the monthly rain boxes	//
				els = document.getElementsByName("rain_lbl")
				for(var i=0; i<els.length; i++) {
					els[i].innerHTML = MONTHS[i]+":";
				}
				
				
				// grab the helper images //
				els = document.getElementsByName("roof_imgs");
				for(var i=0; i<els.length; i++) {
					els[i].innerHTML = "<a href="+ROOF_URLS[i]+"target='_blank'><img src="+ROOF_URLS[i]+" style='height: 126px; width: 126px; margin: 2px; border: 0px; border-radius: 15px;'></img></a>";
				}
				
				updateOutputText(); 	
			}
			
			////////////////////////////////////////////////////////////////////
			////				function initForm()							////
			//// 															////
			////	Initializes the form to not auto-validate so we can 	////
			////	display our own error messages.							////
			////////////////////////////////////////////////////////////////////
			
			function initForm() {
				form = document.getElementById("calc_form");						// Sets the global form so everyone can access it;
				form.noValidate = true;												// Turns off auto-validate so we can self-validate
				form.onchange = validateForm;
				form.onsubmit = validateForm;
				form.onkeyup = validateForm;
				
				
			}
			
			////////////////////////////////////////////////////////////////////
			////				function loadStartingValues()				////
			//// 															////
			////	Loads the starting values into a global array.			////
			////////////////////////////////////////////////////////////////////			
				
			function loadStartingValues() {
				
				document.getElementById("useMonthly").checked = false; 				// make sure checkbox defaults to map-view
				
				allData = {															// initializes the structure of the global, allData 
					place: mun,
					municipality_name: MUN_STARTING_VALUE,
					station_name: STATION_STARTING_VALUE,
					ppl: Number(document.getElementById("ppl").value),				// 	and feeds in initial conditions.
					length: Number(document.getElementById("length").value),
					width: Number(document.getElementById("width").value),
					roof_type: 0,
					useMonthly: Boolean(document.getElementById("useMonthly").checked)
				};
				
				
				els = document.getElementsByName("roof_type");
				for (var i=0; i<els.length; i++) {
					if(els[i].checked) {allData.roof_type = els[i].value}
				}
				
			}	
			
			function hideComplexOutput() {
				document.getElementById("LHS_display").style.opacity = 0;
				document.getElementById("LHS_display").hidden = true;
			}

			
			////////////////////////////////////////////////////////////////////
			////				function updateInputs() 					////
			//// 															////
			////	Updates the global allData with the most-recently-		////
			////	entered data. 											////
			////////////////////////////////////////////////////////////////////
			
			function updateLHS(el) {
				
				if (el.id == "useMonthly") {	// if checkbox is the changed element
					if (el.checked) { 			// if using monthly data
						fadeOut(WaterMapDiv, true)
						fadeIn(MonthlyUseDiv)
					} else {					// if using data from the map	
						fadeOut(MonthlyUseDiv, true)
						fadeIn(WaterMapDiv)
						document.getElementById("calc_button").disabled = false;
					};
				}
				
				if (document.getElementById("useMonthly").checked) {
					if (anyRain()) {
						document.getElementById("calc_button").disabled = false;
					} else {
						document.getElementById("calc_button").disabled = true;
					}
				}
			}
			
			function anyRain() {		// returns true if there's any rain, otherwise returns false.
				var els = document.getElementsByName("rain");
				var totalRain = 0;
				for (var i=0; i<MONTHS.length; i++) {
					totalRain += Number(els[i].value);
				}

				var people = Number(document.getElementById("ppl").value);
				var sensitivity = totalRain/people;
				if (sensitivity > EPSILON) {return true}
				else {return false}
			}
			
			

			
			////////////////////////////////////////////////////////////////////
			////				function updateOutputText() 				////
			//// 															////
			////	Updates the text that's displayed on the LHS display	////
			////	screen after the user submits the form.					////
			////////////////////////////////////////////////////////////////////
			
			
			function updateOutputText() {
				var indent = "\xa0\xa0\xa0";
				
				// print monthly rainfall if entered manually.
				if (allData.useMonthly) {
					DISPLAY_TXT[0] = MONTHLY_USE_TXT+"<br>"
					for (var i=0; i<MONTHS.length; i++) {
						DISPLAY_TXT[0] += indent+FULL_MONTHS[i]+": <b>"+allData[RAINS[i]]+"</b>"+UNITS+"<br>";
					
					
					}
						
				} else { 		// otherwise display person's location
					DISPLAY_TXT[0] = MUN_TXT[0]+allData.municipality_name+MUN_TXT[1]; 	// Display municipality message
				}
				
				// print # of people in household
				if (allData.ppl > 1) { 													// Parse person (1) or people (>1)
					DISPLAY_TXT[1] = PPL_TXT[0]+allData.ppl+PPL_TXT[2];
				} else {
					DISPLAY_TXT[1] = PPL_TXT[0]+allData.ppl+PPL_TXT[1];
				}
				
				// print roof dimensions
				if (allData.length == 1 && allData.width == 1) {
					DISPLAY_TXT[2] = LEN_WID_TXT[0]+allData.length+SINGULAR_DIMENSION+LEN_WID_TXT[1]+allData.width+SINGULAR_DIMENSION+LEN_WID_TXT[2];
				} else if (allData.length == 1) {
					DISPLAY_TXT[2] = LEN_WID_TXT[0]+allData.length+SINGULAR_DIMENSION+LEN_WID_TXT[1]+allData.width+PLURAL_DIMENSION+LEN_WID_TXT[2];
				} else if (allData.width == 1) {
					DISPLAY_TXT[2] = LEN_WID_TXT[0]+allData.length+PLURAL_DIMENSION+LEN_WID_TXT[1]+allData.width+SINGULAR_DIMENSION+LEN_WID_TXT[2];
				} else {
					DISPLAY_TXT[2] = LEN_WID_TXT[0]+allData.length+PLURAL_DIMENSION+LEN_WID_TXT[1]+allData.width+PLURAL_DIMENSION+LEN_WID_TXT[2];
				}
				
				// print roof type
				DISPLAY_TXT[3] = ROOF_TYPE_TXT[0]+ROOF_TYPES_LOWER[allData.roof_type]+ROOF_TYPE_TXT[1];
				
				
				var els = document.getElementsByClassName("water_use"); 	// Display all other water uses. 
				
				var els = document.getElementsByName("display_text"); 		// Actually update all the <p> elements
				for (var i=0; i<els.length; i++) {
					els[i].innerHTML = DISPLAY_TXT[i];
				};
			}
			
			////////////////////////////////////////////////////////////////////
			////	function keydown(event) [Prevent form submit on enter]	////
			//// 															////
			////	checks to see if the key that was pressed was 			////
			////	key #13 (enter/return). If so, it prevents the default 	////
			////	behavior of submitting the form. That way, we never 	////
			////	send the data anywhere, just calculate some stuff with 	////
			////	it here. 												////		
			////////////////////////////////////////////////////////////////////

			
			$(document).ready(function() {
				$(window).keydown(function(event){
					if(event.keyCode == 13) {
					event.preventDefault();
					return false;
					}
				});
			});
			
			////////////////////////////////////////////////////////////////////
			////	function keypress(event) [check validity of keystroke]	////
			//// 															////
			////	checks to see if the key that was pressed was 			////
			////	a valid key. If not, doesn't allow keypress.			////		
			////////////////////////////////////////////////////////////////////
			
			$('input').bind('keypress', function (event) {
				if (event.target.type == "number") { 								// If it's being entered in a numeric field
					//console.log(event)
					//console.log("key pressed is: "+event.originalEvent.charCode)
					if (!event.originalEvent.charCode) {
						return true;
					} else if (!numAcceptableKeys.includes(event.originalEvent.charCode)) { 	// If the key isn't a number or a movement key
						event.preventDefault(); 									// 	prevent behavior
						return false;		
					} else {
						return true;
					};
				} else { 							// If the field isn't a number, allow all behavior.
					return true;
				};	
			});
			
			////////////////////////////////////////////////////////////////////
			////					fucntion validateForm(event)			////
			//// 															////
			////	Takes an element, el. If the value of el is forbidden	////
			////	or outside of the relevant ranges, replaces it with the	////
			////	closest reasonable alternative.							////
			////	This is called every time the form is changed (user		////
			////	leaves the relevant element by pressing tab or clicking	////
			////	outside). At the end, this function calls updateLHS(el)	////
			////	to update the left hand side to account for personal	////
			////	monthly rainwater data entry. 							////
			////////////////////////////////////////////////////////////////////
			
			
			function validateForm(event) {
				event = (event ? event : window.event);
				var el = (event.target ? event.target : event.srcElement);
				var value = Number(el.value);
				if (event.type != 'keyup') {
					if (el.id == "ppl") {
						if (value < el.min)	{
							el.value = el.min;
						} else if (value > el.max) {
							el.value = el.max;
						} else if (value % 1 != 0 & el.id == "ppl") {
							el.value = parseInt(value, 10);
						};
					} else if (el.id == "length" | el.id == "width") {
						if (value < el.min) {
							el.value = el.min;
						} else if (value > el.max) {
							el.value = el.max;
						};
					};
				}
				updateLHS(el)
			}
			
			////////////////////////////////////////////////////////////////////
			////				functions fadeIn(el), fadeOut(el) 			////
			//// 															////
			////	Fades in or out the passed element by adjusting the 	////
			////	the div element's opacity in steps. Many thanks to:		////////////////////
			////	http://www.chrisbuttery.com/articles/fade-in-fade-out-with-javascript/ 	////	
			////	for this simple and lovely bit of js. Cheers! 							////
			////	If the div is visible, fadeIn does nothing. If it's not, fade out 		////	
			////	does nothing. 															////
			////////////////////////////////////////////////////////////////////////////////////
			
			function fadeOut(el, hide){ 
				(function fade() {
					if ((el.style.opacity -= .09) < 0) {
					el.style.opacity = 0;
					} else {
					requestAnimationFrame(fade);
					}
				})();

				if (hide) {
					el.style.display = "none";
				};
				el.hidden = true;
			}
			
			function fadeIn(el){
				
				el.style.opacity = 0;
				el.hidden = false; 
				el.style.display = "inline-block";
				
				(function fade() {
					var val = parseFloat(el.style.opacity);
					if (!((val += .075) > 1)) {
					el.style.opacity = val;
					requestAnimationFrame(fade);
					}
				})();
				
			}
			
			////////////////////////////////////////////////////////////////////
			////		--- BUG FIX FOR QUICK BACK/FORWARD CLICK --- 		////	
			////	function startInterrupt() / checkAndPatchLayout()		////
			//// 															////
			////	This interrupt checks to make sure the correct display	////
			////	is being shown. For even hashes (#0, #2, #4, etc.) the	////
			////	input panel should be full-window. For odd hashes, the 	////
			////	LHS display and RHS results should share the window.	////
			////	startInterrupt() initializes the interrupt which calls	////
			////		checkAndPatchLayout().								////
			////	checkAndPatchLayout() adjusts the display LHS/RHS widths////
			////	based on the hash's parity.								////
			////////////////////////////////////////////////////////////////////

			
			function startInterrupt() {
				var myInterval = setInterval( "checkAndPatchLayout()", INTERRUPT_INTERVAL);  // interrupts to make sure the panels are being displayed correctly
			}
			
			function checkAndPatchLayout() {		// this corrects for people rapidly clicking the browser's "back" or "forward" buttons.
				var hash = Number(location.hash.substring(1));
				if (hash%2 == 0) { 	// if the hash is even, display the input pane
					document.getElementById("left_hand_side").style.width = INPUT_WIDTH_BEFORE;
					document.getElementById("right_hand_side").style.width = OUTPUT_WIDTH_BEFORE;
					document.getElementById("caminos_logo2").style.display = "none";				
				} else {		// if the hash is odd, display the output/display panes
					document.getElementById("left_hand_side").style.width = INPUT_WIDTH_AFTER;
					document.getElementById("right_hand_side").style.width = String(window.innerWidth - INPUT_WIDTH_AFTER_RAW - 1)+"px";
					document.getElementById("caminos_logo2").style.display = "block";
				}
			}

			////////////////////////////////////////////////////////////////////
			////			function displayOutputs				 			////
			//// 															////
			////	Takes the calculated outputs and displays them on the	////
			////	right hand side panel. 									////
			////////////////////////////////////////////////////////////////////
			
			
			function displayOutputs(o) {
				document.getElementById("min_header").innerHTML = MIN_HEADER;
				document.getElementById("real_header").innerHTML = REAL_HEADER;
				
				var ie = false;
				if (navigator.appName == 'Microsoft Internet Explorer' ||  !!(navigator.userAgent.match(/Trident/) || navigator.userAgent.match(/rv 11/))) {
					ie = true;
				}
	
				var elRealRoof = document.getElementsByName("real_roof")[0]
				var elRealTank = document.getElementsByName("real_tank")[0]
				var elRealTankLbls=document.getElementsByName("real_roof_lbl");
				
				if (o.minRoofArea <= o.actualRoofArea) {		// if the user's roof is large enough
					elRealRoof.style.backgroundColor = GREEN;
					elRealTank.style.backgroundColor = GREEN;
					elRealTankLbls[0].innerHTML = REAL_ROOF_LBL_GREEN[0];
					elRealTankLbls[1].innerHTML = REAL_ROOF_LBL_GREEN[1]+"\xa0<b><big>"+String(o.essentialDailyUse)+"</b></big>\xa0"+REAL_ROOF_LBL_GREEN[2];
					document.getElementsByName("real_tank_numb")[0].innerHTML = numberWithCommas(Math.round(o.actualTankVolume));
				} else {										// if the user's roof is too small
					elRealRoof.style.backgroundColor = RED;
					elRealTank.style.backgroundColor = RED;
					elRealTankLbls[0].innerHTML = REAL_ROOF_LBL_RED[0];
					elRealTankLbls[1].innerHTML = REAL_ROOF_LBL_RED[1]+"\xa0<b><big>"+String(o.essentialDailyUse)+"</b></big>\xa0"+REAL_ROOF_LBL_RED[2];
					document.getElementsByName("real_tank_numb")[0].innerHTML = numberWithCommas(Math.round(Math.max.apply(null, [o.actualTankVolume, o.maxMonthlyCollection])));
				
				}
				
				document.getElementsByName("min_roof_numb")[0].innerHTML = numberWithCommas(Math.round(o.minRoofArea));		// fill in numbers rounded to nearest int.
				document.getElementsByName("min_tank_numb")[0].innerHTML = numberWithCommas(Math.round(o.minTankVolume));
				document.getElementsByName("real_roof_numb")[0].innerHTML = numberWithCommas(Math.round(o.actualRoofArea));
				
				

				
				var els=document.getElementsByName("real_tank_lbl");
				for (var i=0; i<els.length; i++) {
					els[i].innerHTML = REAL_TANK_LBL[i];
				}	
				var els=document.getElementsByName("min_roof_lbl");
				for (var i=0; i<els.length; i++) {
					els[i].innerHTML = MIN_ROOF_LBL[i];
				}
				
				var els=document.getElementsByName("min_tank_lbl");
				for (var i=0; i<els.length; i++) {
					els[i].innerHTML = MIN_TANK_LBL[i];
				}
				
				
			}
			
			////////////////////////////////////////////////////////////////////
			////			function incrementHash			 				////
			//// 															////
			////	Grabs the current hash from the URL and stores it in	////
		 	////	the global "hash". Then increments the URL's hash by 1.	////  
			////////////////////////////////////////////////////////////////////
			
			function incrementHash() {
				hash = Number(location.hash.substring(1));
				location.hash = hash+1;	
			}
			
			////////////////////////////////////////////////////////////////////
			////			function onhashchange			 				////
			//// 															////
			////	When the hash changes, if the parity is the same, do 	////
			////	nothing. Otherwise, toggle to the other state. After	////
			////	toggling, adjust the global "hash" to the current value	////
			////////////////////////////////////////////////////////////////////
			
			window.onhashchange = function() { 
			var hashNumb = Number(location.hash.substring(1));
				if (hashNumb%2 != hash%2) {	// if we're going to a new page, do some stuff...
					
					if (hashNumb%2 == 1) { // if the new hash is odd, display the output panel
						left2right();
					} else { 										// if the hash is even, display the input panel
						right2left();
					}
					hash = Number(location.hash.substring(1));	// update so that current previous hash = current hash
					
				}	
				
			}
			
			////////////////////////////////////////////////////////////////////
			////	functions left2right / right2left / replace(e0, e1)		////
			//// 															////
			////	The functions execute the preliminary steps in switching////
			////	from the input (left) panel to the display/results		////
			////	(right) panel:											////
			////	left2right --- do all calculations! swap out the LHS 	////
			////		content, then shift the panel widths.				////
			////	right2left --- same as above but without the calcs.		////
			////	replace(e0, e1) --- fades out e0 and fades in e1. e0 is	////
			////		hidden in the process.
			////////////////////////////////////////////////////////////////////
			
			function left2right() {
				calculateStuff(); 
				replace('LHS_inputs','LHS_display'); 
				widthShift();
				
			}
			
			function right2left() {
				replace('LHS_display','LHS_inputs');
				widthShift();
			}
			
			function replace(e2hide, e2show) {
				fadeOut(document.getElementById(e2hide), true);
				fadeIn(document.getElementById(e2show));
			}
			
			////////////////////////////////////////////////////////////////////
			////			function widthShift				 				////
			//// 															////
			////	Toggles between the input and results panels.			////
			////	Slides all scrollbars to the top after each toggle.		////
			////////////////////////////////////////////////////////////////////
			
			function widthShift() {
				
				var lhs = document.getElementById("left_hand_side").offsetWidth;
				var rhs = document.getElementById("right_hand_side").offsetWidth;
				
				if (lhs > rhs) {
					document.getElementById("left_hand_side").style.width = INPUT_WIDTH_AFTER;
					document.getElementById("right_hand_side").style.width = String(window.innerWidth - INPUT_WIDTH_AFTER_RAW - 1)+"px";
					document.getElementById("caminos_logo2").style.display = "block";
					$("#right_hand_side").scrollTop(0);	
					$("#LHS_display").scrollTop(0);
					
				} else {
					document.getElementById("left_hand_side").style.width = INPUT_WIDTH_BEFORE;
					document.getElementById("right_hand_side").style.width = OUTPUT_WIDTH_BEFORE;
					document.getElementById("caminos_logo2").style.display = "none";
					$("#right_hand_side").scrollTop(0);
					$("#LHS_inputs").scrollTop(0);
				};
			}
			
			
			
			////////////////////////////////////////////////////////////////////
			////			function inputs2outputs				 			////
			//// 															////
			////	Takes the user's entered inputs and converts them into	////
			////	outputs. This is the function that contains all of the 	////
			////	citeable-materials, it is the backbone of the actual	////
			////	calculation process.									////
			////															////
			////	Arguments:												////
			////		inputs --- a dictionary of all of the user inputs	////
			////															////	
			////	Returns:												////
			////		outputs --- a dictionary of things to display to 	////
			////					user. Fields include:					////
			////						essentialDailyUse [L/day]			////
			////						totalOtherUse [L/day]				////
			////						minTankSize [L]						////
			////						montlyUse [L] (a 1x12 array with a 	////
			////							cell for each month's use)		////
			////						monlyCollection [L] (1x12 array) 	////
			////															////
			////	Algorithm: 												////
			////		CHANTAL WILL FILL OUT THIS SECTION OF THE COMMENTS	////
			////		WITH HER USUAL FOCUS ON STYLE AND CLARITY =)		////
			////															////
			////	Update/Revision History:								////
			////		aaron krupp 	2/Nov/2016	empty function written	////	
			////									comments header written ////
			////////////////////////////////////////////////////////////////////			
			
			function inputs2outputs(inputs) {
				var outputs = {essentialDailyUse: 0,
					minTankVolume: 0,
					minRoofArea: 0,
					actualRoofArea: 0,
					actualTankVolume: 0,
					maxMonthCollection: 0
				};
				
				//console.log(inputs)
				
				//////////////////////////////////////////////////////////////////
				//	This next sextion calculates the minimum adequate roof 		//
				//	and cistern sizes for the provided family size and area.	//
				//////////////////////////////////////////////////////////////////
				
				//variable which express the liters of drinking + liters of cooking for one person
				var essential = ESSENTIAL_DAILY_USE * (inputs.ppl);      

				var rainfall;
				if (inputs.useMonthly) { 					// grab monthly use rain
					rainfall = [inputs.jan_rain, inputs.feb_rain, inputs.mar_rain, inputs.apr_rain, inputs.may_rain, inputs.jun_rain, inputs.jul_rain, inputs.aug_rain, inputs.sep_rain, inputs.oct_rain, inputs.nov_rain, inputs.dec_rain];
				} else {
					rainfall = getRainfall(inputs.place); 	// grabs rainfall from geojson data for the selected polygon. 
				}
				
				// next lines are for displaying used rain data //
				var	totalRain = 0;
				for (var i=0; i<12; i++){
					console.log(FULL_MONTHS[i]+": "+rainfall[i]+" mm");
					totalRain += Number(rainfall[i]);
				}
				console.log("TOTAL RAINFALL: "+totalRain+" mm");
				/////////////////////////////////////////////////
				
				var testArea = 0;							// start with area of 0 (it gets bumped up to 1 in the first loop itteration);
				var testAreaAdequate = false;				// default: user doesn't have adequate roof space.
				
				if (rainfall[0] != -1 && totalRain != 0) {		// as long as something's been entered for rainfall:						// if the rainfall data has loaded:
					var test;								
					while (!testAreaAdequate) {				// while there isn't enough roof area
						testArea=testArea+1;				// increment the area
						
						var test;
						if (inputs.useMonthly) {
							test = getCisternSize(rainfall, testArea, EFFS[inputs.roof_type], essential ,-1 , inputs.useMonthly) 	// get the cistern size for entered monthly rainfall
						} else {
							test = getCisternSize(rainfall, testArea, EFFS[inputs.roof_type], essential , SMA_START_MONTH, inputs.useMonthly) // get cistern size for Independence watershed
						}
						
						testAreaAdequate = test.adequate;	// and store whether this roof is adeqaute 
					}
				} else {									// If the rainfall data hasn't loaded yet
					var test = {adequate: false, volume: 0}// 	fill with some made up data
					testArea = 99999999999999;				// This is just an outrageously large number 
				}											//	so that it will say "your roof isn't big enough!"
															//	if the user hasn't entered a roof size. 

				//////////////////////////////////////////////////////////////////
				//	This next sextion calculates the required minimum cistern 	//
				//	size if the user wanted to collect 100% of the water off	//
				//	their provided roof size in the average year. 				//
				//////////////////////////////////////////////////////////////////
				
				var actualArea = inputs.length * inputs.width;
				var actual;
				if(inputs.useMonthly) {
					actual = getCisternSize(rainfall, actualArea, EFFS[inputs.roof_type], essential, -1, inputs.useMonthly);
				} else {
					actual = getCisternSize(rainfall, actualArea, EFFS[inputs.roof_type], essential, SMA_START_MONTH, inputs.useMonthly);
				}

				var maxRain = Math.max.apply(null, rainfall);
				var maxMonthlyCollection = maxRain*actualArea;
				
				outputs.essentialDailyUse = essential; 		// Water consumption for cooking & drinking [L/day]
				outputs.minTankVolume = test.volume;		// once the roof size is adequate, this is the volume of the requisite cistern [L]
				outputs.actualRoofArea = actualArea;		// the user-provided roof area [m2]
				outputs.minRoofArea = testArea;				// and this holds the minimum acceptable roof size for supporting the given population [m2]
				outputs.actualTankVolume = actual.volume;	// cistern volume required to capture 100% of rainfall on user-provided roof area [L]					
				outputs.maxMonthlyCollection = maxMonthlyCollection // maximum volume collectible in a month
				return outputs 				
				
			}
			
			////////////////////////////////////////////////////////////////////
			////			function getCisternSize				 			////
			//// 															////
			////	Args:
			////		rainfall 	1x12 array with monthly rainfall [mm]	////	
			////		area		area of the roof [m2]					////
			////		eff			efficiency of roof [0,1]				////
			////		dailyUse 	household's daily avg water consumption	////
			////					[L/day]									////
			////
			////	Returns:
			////		.adequate 	tells if a roof is large enough to 		////
			////					support the provided daily use for the 	////
			////					entire year. [boolean]					////
			////		.volume		returns the cistern volume required to	////
			////					capture 100% of rainwater from the 		////
			////					provided roof area and rainfall [L].	////
			////															////
			////	Algorithm:												////
			////		Loops through all months. Calculates 				////
			////		inventory[i] = inventory[i-1] + collected[i] - use[i] //
			////		Begins this process at START_MONTH which can be set ////
			////		in globals.js. If any month has an inventory of 0,	////
			////		then .adequate returns false. otherwise, it returns	////
			////		true. 	
			////////////////////////////////////////////////////////////////////
			
			function getCisternSize(rainfall, area, eff, dailyUse, startMonth, useMonthly) {
				var results = {adequate: true, volume: 0};
				var inventory = Array.apply(null, Array(DAY_MON.length)).map(Number.prototype.valueOf,0);
			
				var single_first_flush = area*CLEANLINESS_FACTOR;	// number of liters removed in 1st flush system
				
				if(startMonth == -1) {
					
					startMonth = rainfall.indexOf(Math.max.apply(null, rainfall));
				}
				
				for (var i=startMonth; i<DAY_MON.length+startMonth; i++) {
					var monthlyUse = dailyUse*DAY_MON[i%DAY_MON.length];							// people * L/(people*day) * day/month = [L/month]
					var losses2first_flush = single_first_flush*RAIN_EVENTS[i%DAY_MON.length]		// (liters flushed / rain event) * # of rain events
					if (useMonthly) {
						losses2first_flush = single_first_flush*NULL_RAIN_EVENTS[i%DAY_MON.length]		// if the user isn't from SMA, don't account for 1st flush losses.
					}
					
					
					inventory[i%DAY_MON.length] = (rainfall[i%DAY_MON.length]*area*eff - losses2first_flush)- monthlyUse;		// (collectible rainfall - amount 1st flushed per month) - monthly consumption = [L stored/month] 			
					
					if ( i%DAY_MON.length != startMonth ) {					// For all months but the first one,
						if (i%DAY_MON.length == 0) {
							inventory[i%DAY_MON.length]=inventory[DAY_MON.length-1]+inventory[i%DAY_MON.length];// if january, add to inventory of december
						} else {																				//	add the current inventory to the previous. (even when its 0).
							inventory[i%DAY_MON.length]=inventory[(i-1)%DAY_MON.length]+inventory[i%DAY_MON.length];	
						}
					}																				
							
					if (inventory[i%DAY_MON.length]<0) { 							// Make sure that inventory is >=0
						inventory[i%DAY_MON.length]=0;								// 	if not, set it to zero
						results.adequate = false;						// 	and indicate that the roof space is inadequate for the family's needs
					}
				}
				//console.log("rainfall: "+rainfall)
				//console.log("area: "+area)
				//console.log("eff: "+eff)
				//console.log(inventory)
				//console.log(results.adequate)
				results.volume = Math.max.apply(null, inventory);		// The volume of the tank is the max value of the inventory.
				return results	
			}
			
			function addTooltipText(el) {
				var name = el.getAttribute("name"); 			// grab the element name
				if (name != currentTooltipName) {				// if we're on a new name	
					for(var i=0; i<el.children.length; i++) {	// loop through all children
						if (el.children[i].nodeName != "BR") {	// make sure to ignore any <br> elements
							el.children[i].innerHTML = TOOLTIP_TEXT[name];
							break;								// set the next element to the desired inner HTML
						}										//	then break out of the for-loop.
					}
				}
			}
							
			
			function numberWithCommas(x) {
				return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
			}
			
			function highlight(el) {
				el.style.color = LIGHT_BLUE;
			}
			
			function unHighlight(el) {
				el.style.color = BLACK;
			}

			function calculateStuff() {
				allData.jan_rain = Number(document.getElementById("jan_rain").value);
				allData.feb_rain = Number(document.getElementById("feb_rain").value);
				allData.mar_rain = Number(document.getElementById("mar_rain").value);
				allData.apr_rain = Number(document.getElementById("apr_rain").value);
				allData.may_rain = Number(document.getElementById("may_rain").value);
				allData.jun_rain = Number(document.getElementById("jun_rain").value);
				allData.jul_rain = Number(document.getElementById("jul_rain").value);
				allData.aug_rain = Number(document.getElementById("aug_rain").value);
				allData.sep_rain = Number(document.getElementById("sep_rain").value);
				allData.oct_rain = Number(document.getElementById("oct_rain").value);
				allData.nov_rain = Number(document.getElementById("nov_rain").value);
				allData.dec_rain = Number(document.getElementById("dec_rain").value);
				allData.ppl = Number(document.getElementById("ppl").value);
				allData.length = Number(document.getElementById("length").value);
				allData.width = Number(document.getElementById("width").value);
				allData.useMonthly = document.getElementById("useMonthly").checked;
				allData.municipality_name = String(geojson._layers[mun].feature.properties.NOMGEO);	
				allData.station_name = String(geojson._layers[mun].feature.properties.Station);	
				allData.place = mun;
				
				var radios = document.getElementsByName("roof_type");
				for (var i=0; i<radios.length; i++) {
					if (radios[i].checked) {
						allData.roof_type = radios[i].value;
					}
				}
				
				updateOutputText();						// Update LHS display 
				displayStuff = inputs2outputs(allData); // calculate!
				displayOutputs(displayStuff); 			// display the calcuated values on the RHS!
				
				
			
			}
			
			window.onresize = function(event) {
				var lhs = document.getElementById("left_hand_side").offsetWidth;
				var rhs = document.getElementById("right_hand_side").offsetWidth;
				if (rhs != 0) {
					document.getElementById("left_hand_side").style.width = INPUT_WIDTH_AFTER;
					document.getElementById("right_hand_side").style.width = String(window.innerWidth - INPUT_WIDTH_AFTER_RAW - 1)+"px";
					$("#right_hand_side").scrollTop(0);	
				}
			};
			
     
		</script>
	</body>
</html>
